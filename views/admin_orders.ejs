<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin - Orders</title>
  <style>
    :root{ --primary:#d14343; --primary-ink:#8b1f1f; --ink:#0f172a; --muted:#6b7280; --card:#ffffff; --ring:#e5e7eb; --radius:16px; --shadow:0 10px 30px rgba(15,23,42,.08); --space:18px; --max:1160px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;font-size:18px;color:var(--ink);background:linear-gradient(180deg,#fff,#fff 45%,#fdf6f6 100%)}
    a{color:var(--primary);text-decoration:none}
    .container{max-width:var(--max);margin:0 auto;padding:24px}
    .navbar{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--ring)}
    .navwrap{max-width:var(--max);margin:0 auto;display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px 24px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.3px;color:var(--primary-ink);font-size:1.15rem}
    .brand svg{width:28px;height:28px}
    .navlinks{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .navlinks a{color:var(--ink);opacity:.9;font-size:1.05rem}
    .badge{padding:7px 14px;border-radius:999px;background:#ffe6e6;color:#8b1f1f;font-weight:800;border:1px solid #ffd1d1}
    .user-pill{border:none;background:#ffe6e6;color:#8b1f1f;padding:6px 14px;border-radius:999px;font-weight:800;cursor:pointer;font-size:1rem;display:flex;align-items:center;gap:8px;box-shadow:0 6px 16px rgba(15,23,42,.12);}
    .user-pill img{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #f7caca;background:#fff;}
    .user-menu{position:absolute;right:0;top:46px;background:#fff;border:1px solid var(--ring);border-radius:12px;box-shadow:0 16px 40px rgba(15,23,42,.25);padding:10px;min-width:220px;display:none;z-index:50;}
    .user-menu.is-visible{display:block;}
    .user-menu .entry{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
    .user-menu .entry strong{font-size:1rem;}
    .user-menu .entry span{color:#64748b;font-size:.9rem;}
    .user-menu a{display:block;padding:10px 14px;border-radius:10px;font-weight:700;color:#b91c1c;border:1px solid transparent;}
    .user-menu a:hover{background:#fef3f3;border-color:#f3c4c4;}
    .card{background:#fff;border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow);margin-top:16px}
    .card-body{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .input{border:1px solid var(--ring);border-radius:12px;padding:10px 12px;font-size:1rem;background:#fff}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--ring);background:#fff;cursor:pointer;font-weight:800;transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(15,23,42,.12)}
    .btn.primary{background:#d14343;border-color:#d14343;color:#fff}
    .btn.ghost{background:#fff;color:#8b1f1f;border-color:#f3c4c4}
    .btn.danger{background:#991b1b;border-color:#991b1b;color:#fff}
    .btn.small{padding:8px 12px;border-radius:10px;font-size:.95rem}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px 14px;border-bottom:1px solid var(--ring);text-align:left;vertical-align:top}
    .detail-row td{background:#fdfdfd}
    .item-pill{display:inline-flex;align-items:center;gap:6px;border-radius:10px;padding:6px 10px;border:1px solid #e5e7eb;margin:4px;flex-wrap:wrap;background:#fff}
    .status-pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 12px;font-weight:700;border:1px solid #e5e7eb;background:#f8fafc}
    .actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  </style>
</head>
<body>
<header class="navbar" role="navigation" aria-label="Primary">
  <div class="navwrap">
    <div class="brand" aria-label="Mala Hot Pot Market">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M6 12c3.5-3.5 6-2 10-6 1.6-1.6 3-1.5 3 0 0 2-2 4-3 5-5 5-7 8-11 8-2.5 0-3.5-1.5-3-3 1-3 2-3 4-4z" stroke="#d14343" stroke-width="1.5" fill="#ffdddd"/>
        <path d="M15 6c0-2 1-3 3-3" stroke="#8b1f1f" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span>Mala Hot Pot Market</span>
    </div>
    <nav class="navlinks" aria-label="Admin">
      <a href="/">Home</a>
      <a href="/admin">Store</a>
      <a href="/admin/products">Product Update</a>
      <a href="/admin/users">User &amp; Member</a>
      <a href="/admin/orders">Orders</a>
      <a href="/admin/reports">Reports</a>
    </nav>
    <div style="position:relative">
      <button class="user-pill" id="avatarBtn" type="button">
        <% if (user && user.avatar_url) { %>
          <img src="<%= user.avatar_url %>" alt="avatar" />
        <% } else { %>
          <span style="width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid #f7caca;font-weight:800;color:#8b1f1f;font-size:.85rem;">A</span>
        <% } %>
        <span>Admin</span>
      </button>
      <div id="userMenu" class="user-menu" aria-live="polite">
        <div class="entry">
          <% if (user && user.avatar_url) { %>
            <img src="<%= user.avatar_url %>" alt="avatar" width="32" height="32" />
          <% } else { %>
            <span style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#ffe6e6;font-weight:800;color:#8b1f1f;">A</span>
          <% } %>
          <div>
            <strong><%= user ? user.name : 'Admin' %></strong>
            <span><%= user ? user.role : 'Admin' %></span>
          </div>
        </div>
        <a href="/account">My Profit</a>
        <a href="/logout">Logout</a>
      </div>
    </div>
  </div>
</header>
<script>
  (function(){
    const pill = document.getElementById('avatarBtn');
    const menu = document.getElementById('userMenu');
    if (!pill || !menu) return;
    pill.addEventListener('click', function(ev){
      ev.preventDefault();
      menu.classList.toggle('is-visible');
    });
    document.addEventListener('click', function(ev){
      if (!menu.contains(ev.target) && !pill.contains(ev.target)) {
        menu.classList.remove('is-visible');
      }
    });
  })();
</script>

<main class="container">
  <h1 style="margin:8px 0 8px 0">Orders Management</h1>
  <% if (refundAlert === 'ok') { %>
    <div class="card" style="margin-top:8px;border-color:#a7f3d0;background:#ecfdf5">
      <div class="card-body" style="color:#065f46;font-weight:800">Refund processed.</div>
    </div>
  <% } else if (refundAlert === 'pending') { %>
    <div class="card" style="margin-top:8px;border-color:#fde68a;background:#fffbeb">
      <div class="card-body" style="color:#92400e;font-weight:800">Refund pending. PayPal may take a few minutes.</div>
    </div>
  <% } else if (refundAlert === 'unsupported') { %>
    <div class="card" style="margin-top:8px;border-color:#fed7aa;background:#fff7ed">
      <div class="card-body" style="color:#9a3412;font-weight:800">Refund not supported for this payment method.</div>
    </div>
  <% } else if (refundAlert === 'missing_tx') { %>
    <div class="card" style="margin-top:8px;border-color:#fecaca;background:#fff1f2">
      <div class="card-body" style="color:#991b1b;font-weight:800">PayPal refund failed: missing transaction record.</div>
    </div>
  <% } else if (refundAlert === 'error') { %>
    <div class="card" style="margin-top:8px;border-color:#fecdd3;background:#fff1f2">
      <div class="card-body" style="color:#991b1b;font-weight:800">Refund failed. Please try again.</div>
    </div>
  <% } else if (refundAlert === 'missing_request') { %>
    <div class="card" style="margin-top:8px;border-color:#fde68a;background:#fffbeb">
      <div class="card-body" style="color:#92400e;font-weight:800">No pending refund request for this order.</div>
    </div>
  <% } %>
  <section class="card">
    <div class="card-body">
      <form class="row" method="get" action="/admin/orders">
        <input class="input" name="q" placeholder="Search by order ID or customer" value="<%= q %>">
        <select name="status" class="input">
          <% statuses.forEach(function(st){ %>
            <option value="<%= st %>" <%= status === st ? 'selected' : '' %>><%= st %></option>
          <% }) %>
        </select>
        <button class="btn" type="submit">Filter</button>
      </form>
    </div>
    <div class="card-body" style="padding-top:0">
      <table>
        <thead>
          <tr>
            <th>Order</th>
            <th>User</th>
            <th>Total</th>
            <th>Payment</th>
            <th>Status</th>
            <th>Placed</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
        <% if (orders && orders.length) { %>
          <% orders.forEach(function(order) { %>
            <% const refundReq = (refundByOrder && refundByOrder[order.order_id]) ? refundByOrder[order.order_id] : null; %>
            <tr>
              <td><strong>#<%= order.order_id %></strong></td>
              <td><%= order.user_name %></td>
              <td>$<%= Number(order.total_amount).toFixed(2) %></td>
              <td><%= order.payment_method ? order.payment_method : 'N/A' %></td>
              <td><span class="status-pill"><%= order.status %></span></td>
              <td><%= order.created_at.toISOString ? order.created_at.toISOString().slice(0,19).replace('T',' ') : order.created_at %></td>
              <td>
                <div class="actions">
                  <a class="btn ghost small" href="/admin/orders/<%= order.order_id %>/print" target="_blank" rel="noopener">Print</a>
                  <% const method = (order.payment_method || '').toLowerCase(); %>
                  <% if (String(order.status).toLowerCase() !== 'refunded' && (method === 'paypal' || !method) && refundReq && refundReq.status === 'requested') { %>
                    <button class="btn danger small" type="button" data-refund-btn data-order-id="<%= order.order_id %>" data-items='<%- JSON.stringify(itemsByOrder[order.order_id] || []) %>'>Refund</button>
                  <% } else if (!refundReq) { %>
                    <button class="btn small" type="button" disabled title="No refund request">No Request</button>
                  <% } else if (String(order.status).toLowerCase() !== 'refunded' && method && method !== 'paypal') { %>
                    <button class="btn small" type="button" disabled title="Refund available for PayPal only">No Refund</button>
                  <% } %>
                </div>
              </td>
            </tr>
            <tr class="detail-row">
              <td colspan="7">
                <% if (refundReq) { %>
                  <div style="margin-bottom:10px;padding:10px;border:1px solid #fde68a;background:#fffbeb;border-radius:12px">
                    <strong>Refund Request:</strong>
                    <span style="margin-left:6px"><%= refundReq.reason %></span>
                    <span style="margin-left:10px;color:#92400e;font-weight:700">( <%= refundReq.status %> )</span>
                  </div>
                <% } %>
                <div style="display:flex;flex-wrap:wrap;gap:8px">
                  <% const items = itemsByOrder[order.order_id] || []; %>
                  <% if (items.length) { %>
                    <% items.forEach(function(item){ %>
                      <div class="item-pill">
                        <strong><%= item.name %></strong>
                        <span>Qty: <%= item.quantity %></span>
                        <span>$<%= Number(item.line_total).toFixed(2) %></span>
                      </div>
                    <% }) %>
                  <% } else { %>
                    <span style="color:var(--muted)">No items recorded.</span>
                  <% } %>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="7" style="color:var(--muted)">No orders found.</td></tr>
        <% } %>
        </tbody>
      </table>
    </div>
  </section>
</main>

<div id="refundModal" style="position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:120;">
  <div style="background:#fff;border:1px solid var(--ring);border-radius:16px;box-shadow:var(--shadow);width:min(92vw,520px);padding:18px;">
    <h3 style="margin:0 0 8px 0">Refund Order</h3>
    <form id="refundForm" method="post">
      <p style="margin:0 0 12px 0;color:#64748b">Choose refund quantities for each item.</p>
      <div id="refundItems" style="display:flex;flex-direction:column;gap:10px;margin-bottom:12px"></div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <input type="checkbox" id="restockToggle" name="restock" value="1" checked />
        <label for="restockToggle" style="font-weight:700">Restock refunded items</label>
      </div>
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn small" type="button" id="refundAllBtn">Refund All</button>
        <button class="btn ghost" type="button" id="refundCancel">Cancel</button>
        <button class="btn primary" type="submit">Confirm Refund</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function(){
    const modal = document.getElementById('refundModal');
    const itemsBox = document.getElementById('refundItems');
    const form = document.getElementById('refundForm');
    const cancelBtn = document.getElementById('refundCancel');
    const refundAllBtn = document.getElementById('refundAllBtn');
    const restockToggle = document.getElementById('restockToggle');
    if (!modal || !itemsBox || !form) return;

    function openModal(orderId, items){
      itemsBox.innerHTML = '';
      if (restockToggle) restockToggle.checked = true;
      (items || []).forEach(function(item){
        const row = document.createElement('div');
        row.className = 'item-pill';
        const maxQty = Number(item.quantity || 0);
        const unit = Number(item.unit_price || 0);
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.gap = '10px';
        row.innerHTML =
          '<div style="display:flex;flex-direction:column;gap:4px">' +
            '<strong>' + (item.name || 'Item') + '</strong>' +
            '<span style="color:var(--muted)">Ordered: ' + maxQty + ' @ $' + unit.toFixed(2) + '</span>' +
          '</div>' +
          '<div style="display:flex;align-items:center;gap:8px">' +
            '<label style="font-weight:700">Refund</label>' +
            '<input class="input refund-qty" data-max="' + maxQty + '" style="width:90px" type="number" min="0" max="' + maxQty + '" step="1" name="refund_qty[' + item.order_item_id + ']" value="0" />' +
          '</div>';
        itemsBox.appendChild(row);
      });
      if (!items || !items.length) {
        const empty = document.createElement('span');
        empty.style.color = 'var(--muted)';
        empty.textContent = 'No items recorded.';
        itemsBox.appendChild(empty);
      }
      form.action = '/admin/orders/' + orderId + '/refund';
      modal.style.display = 'flex';
    }
    function closeModal(){ modal.style.display = 'none'; }

    document.querySelectorAll('[data-refund-btn]').forEach(function(btn){
      btn.addEventListener('click', function(){
        let items = [];
        try { items = JSON.parse(btn.getAttribute('data-items') || '[]'); } catch (e) {}
        openModal(btn.getAttribute('data-order-id'), items);
      });
    });
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function(ev){
      if (ev.target === modal) closeModal();
    });
    if (refundAllBtn) {
      refundAllBtn.addEventListener('click', function(){
        itemsBox.querySelectorAll('.refund-qty').forEach(function(input){
          const max = Number(input.getAttribute('data-max') || 0);
          input.value = String(max);
        });
      });
    }
  })();
</script>
</body>
</html>
